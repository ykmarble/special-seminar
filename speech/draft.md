# Pythonによるファイルシステムとシェルの作成実験

201311357 黒川佑郁

---
## 目次

1、2、3、4とこういった流れで発表を進めさせていただきます。まず、元々
どういった目的で情報特別演習を履修したかです。

---
## 当初の方向性

当初の目的は、OSがやっていることは本とかを読めばそれとなく分かるけれど、
やっぱり実際に作ってその仕組みや考え方を学びたい、とかなり漠然したものでした。
ここまで漠然としていた理由として大きなものに、とりあえず情報特別演習を
履修してみたかったというのがあります。

---
## 30日でできる! OS自作入門

巷ではOS自作は30日でできるという噂が流れているのですが、1からOSを書く自信もなかった
ので、OSの機能を一つ一つ仮想的に作ってみようということになりました。

---
## 目次

そこで、とりあえずファイルシステムを作ってみることにしました。

---
## 製作物その1 ファイルシステム

Pythonが一番手に馴染んでいるのでPythonで作れたらいいなと思っていたのですが、
FUSEとそのPythonバインディングであるllfuseを使うとそれっぽいものが
作れそうなことが分かったのでこの方法を採用しました。

---
## FUSEとは

FUSEというのはFilesystem in USErspaceの略で、カーネルをいじることなく
普通のプログラムを書いてAPIを呼ぶだけでファイルシステムとして扱ってくれる
仕組みです。

---
## イメージ

図を交えて説明しますと、右上のfs.pyというのが自分で書いたプログラムで、
pyonディレクトリにこのファイルシステムをマウントしたとします。
そして左上のプログラムがpyonディレクトリ内のファイルにアクセスしようと
すると、まずVFSがその命令を受け取って対応するファイルシステムの
対応するプログラムを実行してくれます。FUSEの場合はここからもう一回飛んで
自分で書いたプログラムの方を実行してくれるという流れです。

FUSEのAPIをPythonから呼べるようにしたのがllfuseで、llfuse.Operationを
継承したクラスを作りメソッドをオーバーライドしてllfuse.initにそのクラス
を渡してあげるだけで組み込める。

---
## メソッドの一例

llfuse.Operationにはこういったメソッドが定義されていて、これらを
オーバーライドしていくことが主な作業となりました。

---
## 完成したファイルシステムの概要

ファイルシステムのデータを一つのファイルに書き出すことで管理しています。
感覚としてはisoをループバックマウントしてるようなものです。確かアクセス制限が
未実装のままなのでファイルモードがただの飾りになっています。

## ファイル構造

このファイルには先頭から順にinode構造体のエントリ数、block数、inode番号の使用状況、
blockの使用状況、inode構造体の配列、blockの配列が含まれています。

---
## ファイルシステムのデモ

* ディレクトリが空なのを見せる
* mount
* 何か予め作っておいて読めているのを見せる
* ファイル作成、削除
* ディレクトリ作成、削除
* symlink作成、削除

---
## 目次

ここまでがファイルシステムを作った話で次からがシェルを作った話になります。
ファイルシステムは夏休み時点である程度キリのいい段階にあったので、
秋学期からは違うことをやろうという流れです。

---
## シェルはOSの機能じゃない💢

シェルはOSが用意している機能かといわれると違うのですがこうなったのにも
理由があります。
最初はPythonスクリプトを並列実行するスケジューラを作ってみようかと
考えたのですが全く実現する方法が考えつかなかったので、並列のことは
忘れてとりあえず単体のプログラムを実行できるように目標を設定しました。
この目標を達成するために頑張っていたんですが、気づいたら目の前にシェル
っぽいものができていたんですね。

---
## 製作物その2 シェル

そういうわけで、秋学期はシェルを作りました。また言語にPythonを使って
ますが、今度は特にサードパーティのライブラリは使用していません。

---
## どうやって実行するか

Unix系OSではfork・execすることで新しいプロセスを生み出すことができます。
forkで自分自身をコピーした子プロセスを生み出す事ができます。
execで自分自身を指定したプログラムに置き換えることができるので、
流れとしてはforkして子プロセスをexecで書き換えるというものになります。

---
## 完成したシェルの概要

完成したシェルの機能ですが、まず単一のコマンドを実行することができます。
またパイプ、リダイレクトといったものも動きます。バックグラウンド実行も
できますが、プロセスを一旦止めてバックグラウンドに移したりとかは
できません。論理演算子もサポートしているので条件分岐はできますが
ループがありません。変数に関してはあることはあるのですが読み出ししか
できません。引数を読み出すことができるのでちょっとしたスクリプトなら
書けないこともないです。

---
## シェルのデモ

* slを走らせる
* スリープソート
* リダイレクト
* 論理演算子

---
## 1年全体としての成果

結局1年全体としての成果をまとめるとこのような感じになります。最低限
必要な機能は揃っていると言ってもある程度許されるのではないでしょうか。

---
## 考察・感想

元々の目的であった手を動かしてOS機能を学ぶですが、手を動かすという部分
については達成できたと思っています。それがOS機能を学ぶことにつながっている
かというと微妙ですが。また、気づいたこととしてやっぱり自分で書いて作る
というのは楽しいです。自分の場合、こういった技術について本を読むことに比べて
実際に何かを作ることが少ないので、いい機会だったと思います。forkでプロセスを
作れるみたいな知識は持っていても、実際にforkを使うようなものを書いたことは
fork爆弾ぐらいしか無かったので、プロセス生んでるだけでも楽しかったです。
反省点として、テーマが明確に決まってない状態で始まって、そのまま何となく
ファイルシステムとシェルを作っていたら1年が終わってしまったので、
もっと具体的にテーマを決めてからの方がこの講義の特性を活かしたことが
できたのではないかなと思います。以上で発表を終わります。
